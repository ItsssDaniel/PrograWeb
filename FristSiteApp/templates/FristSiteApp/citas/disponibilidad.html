{% extends 'FristSiteApp/base.html' %}
{% load static %}

{% block content %}
<div class="container main-content">
    <div class="section" id="disponibilidad-citas">
        <h2>Ver Disponibilidad de Citas</h2>
        <p>Consulta los horarios disponibles para agendar citas médicas</p>
        
        <!-- Formulario de búsqueda de disponibilidad -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="formDisponibilidad" class="row g-3">
                    {% csrf_token %}
                    <div class="col-md-4">
                        <label for="medico_disponibilidad" class="form-label">Médico</label>
                        <select id="medico_disponibilidad" class="form-select" required>
                            <option value="">Seleccionar médico</option>
                            {% for medico in medicos %}
                            <option value="{{ medico.id }}">{{ medico.nombre }} - {{ medico.especialidad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="fecha_disponibilidad" class="form-label">Fecha</label>
                        <input type="date" id="fecha_disponibilidad" class="form-control" 
                               min="{% now 'Y-m-d' %}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="turno_disponibilidad" class="form-label">Turno (Opcional)</label>
                        <select id="turno_disponibilidad" class="form-select">
                            <option value="mañana">Mañana (6:00 AM - 12:00 PM)</option>
                            <option value="tarde">Tarde (12:00 PM - 6:00 PM)</option>
                            <option value="noche">Noche (6:00 PM - 12:00 AM)</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary" id="btnBuscarDisponibilidad">
                            <i class="fas fa-search me-2"></i>Buscar Disponibilidad
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resultados de disponibilidad -->
        <div id="resultadosDisponibilidad" class="d-none">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Resultados de Disponibilidad</h5>
                </div>
                <div class="card-body">
                    <div id="infoMedicoFecha" class="alert alert-info mb-4">
                        <strong id="medicoNombre"></strong> - <span id="fechaSeleccionada"></span>
                    </div>

                    <!-- Tabs para diferentes turnos -->
                    <ul class="nav nav-tabs mb-4" id="turnosTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="mañana-tab" data-bs-toggle="tab" 
                                    data-bs-target="#mañana" type="button" role="tab">
                                <i class="fas fa-sun me-2"></i>Mañana (6:00 AM - 12:00 PM)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tarde-tab" data-bs-toggle="tab" 
                                    data-bs-target="#tarde" type="button" role="tab">
                                <i class="fas fa-cloud-sun me-2"></i>Tarde (12:00 PM - 6:00 PM)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="noche-tab" data-bs-toggle="tab" 
                                    data-bs-target="#noche" type="button" role="tab">
                                <i class="fas fa-moon me-2"></i>Noche (6:00 PM - 12:00 AM)
                            </button>
                        </li>
                    </ul>

                    <!-- Contenido de los tabs -->
                    <div class="tab-content" id="turnosTabContent">
                        <!-- Turno Mañana -->
                        <div class="tab-pane fade show active" id="mañana" role="tabpanel">
                            <div class="row" id="horariosMañana">
                                <!-- Los horarios disponibles se cargarán aquí dinámicamente -->
                            </div>
                        </div>

                        <!-- Turno Tarde -->
                        <div class="tab-pane fade" id="tarde" role="tabpanel">
                            <div class="row" id="horariosTarde">
                                <!-- Los horarios disponibles se cargarán aquí dinámicamente -->
                            </div>
                        </div>

                        <!-- Turno Noche -->
                        <div class="tab-pane fade" id="noche" role="tabpanel">
                            <div class="row" id="horariosNoche">
                                <!-- Los horarios disponibles se cargarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Citas existentes -->
                    <div class="mt-5" id="citasExistentesSection">
                        <h6 class="mb-3"><i class="fas fa-calendar-times me-2"></i>Citas ya agendadas</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="tablaCitasExistentes">
                                <thead>
                                    <tr>
                                        <th>Hora</th>
                                        <th>Paciente</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Las citas existentes se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-success" id="btnAgendarDesdeDisponibilidad">
                        <i class="fas fa-calendar-plus me-2"></i>Agendar Cita con estos datos
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Variables de diseño moderno */
:root {
    --primary: #2b6cb0;
    --primary-light: #ebf4ff;
    --secondary: #4a5568;
    --accent: #38a169;
    --text: #2d3748;
    --text-light: #718096;
    --background: #ffffff;
    --background-alt: #f7fafc;
    --border: #e2e8f0;
    --shadow: rgba(0, 0, 0, 0.05);
    --max-width: 1200px;
    --border-radius: 12px;
    --transition: all 0.3s ease;
    --danger: #e53e3e;
    --danger-light: #fed7d7;
}

/* Estilos generales para la sección de disponibilidad */
.container.main-content {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 2rem 1.5rem;
}

#disponibilidad-citas {
    background: var(--background);
    border-radius: var(--border-radius);
    padding: 2.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--border);
}

#disponibilidad-citas h2 {
    color: var(--primary);
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-align: center;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

#disponibilidad-citas > p {
    color: var(--text-light);
    text-align: center;
    font-size: 1.1rem;
    margin-bottom: 2.5rem;
    font-weight: 300;
}

/* Card del formulario */
.card {
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    box-shadow: 0 6px 15px var(--shadow);
    background: var(--background);
    transition: var(--transition);
    overflow: hidden;
}

.card:hover {
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.card-header {
    background: var(--background-alt);
    border-bottom: 1px solid var(--border);
    padding: 1.5rem 2rem;
    font-weight: 600;
    color: var(--primary);
}

.card-header h5 {
    font-size: 1.4rem;
    margin: 0;
    font-weight: 600;
}

.card-body {
    padding: 2rem;
}

/* Formulario */
.form-label {
    color: var(--secondary);
    font-weight: 500;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.form-control, .form-select {
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    color: var(--text);
    background: var(--background);
    transition: var(--transition);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
    outline: none;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), #2c5282);
    border: none;
    padding: 0.85rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    transition: var(--transition);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(43, 108, 176, 0.3);
    background: linear-gradient(135deg, #2c5282, var(--primary));
}

.btn-success {
    background: linear-gradient(135deg, var(--accent), #2f855a);
    border: none;
    padding: 0.85rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    transition: var(--transition);
    color: white;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(56, 161, 105, 0.3);
    background: linear-gradient(135deg, #2f855a, var(--accent));
}

/* Tabs */
.nav-tabs {
    border-bottom: 2px solid var(--border);
    margin-bottom: 2rem;
}

.nav-tabs .nav-link {
    color: var(--secondary);
    font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 1rem 1.5rem;
    margin: 0 0.5rem;
    border-radius: 8px 8px 0 0;
    transition: var(--transition);
    font-size: 0.95rem;
}

.nav-tabs .nav-link:hover {
    color: var(--primary);
    background-color: var(--primary-light);
}

.nav-tabs .nav-link.active {
    color: var(--primary);
    font-weight: 600;
    border-bottom: 3px solid var(--primary);
    background-color: var(--primary-light);
}

/* Tarjetas de horarios */
.horario-card {
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
    border-radius: 10px;
    background: var(--background);
    box-shadow: 0 4px 12px var(--shadow);
    border: 1px solid var(--border);
    height: 100%;
    overflow: hidden;
    position: relative;
}

.horario-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    opacity: 0;
    transition: var(--transition);
}

.horario-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
    border-color: var(--accent);
}

.horario-card:hover::before {
    opacity: 1;
}

.horario-card.disponible {
    border-color: var(--border);
}

.horario-card.disponible:hover {
    border-color: var(--accent);
}

.horario-card.ocupado {
    border-color: var(--danger-light);
    opacity: 0.9;
    cursor: not-allowed;
}

.horario-card.ocupado:hover {
    border-color: var(--danger);
    transform: none;
    box-shadow: 0 4px 12px var(--shadow);
}

.horario-card.ocupado:hover::before {
    opacity: 0;
}

.horario-card .card-body {
    padding: 1.75rem 1rem !important;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.horario-card .card-title {
    color: var(--primary);
    font-weight: 600;
    font-size: 1.15rem;
    margin-bottom: 0.75rem;
}

.horario-card.ocupado .card-title {
    color: var(--text-light);
}

/* Badges */
.badge {
    padding: 0.5rem 1.25rem;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.bg-success {
    background: linear-gradient(135deg, var(--accent), #2f855a) !important;
    color: white;
}

.bg-danger {
    background: linear-gradient(135deg, var(--danger), #c53030) !important;
    color: white;
}

.bg-primary {
    background: linear-gradient(135deg, var(--primary), #2c5282) !important;
    color: white;
}

.bg-warning {
    background: linear-gradient(135deg, #d69e2e, #b7791f) !important;
    color: white;
}

.bg-secondary {
    background: linear-gradient(135deg, var(--secondary), #2d3748) !important;
    color: white;
}

/* Alertas */
.alert {
    border-radius: var(--border-radius);
    border: none;
    padding: 1.25rem 1.5rem;
    font-size: 1rem;
}

.alert-info {
    background: linear-gradient(135deg, var(--primary-light), #e6fffa);
    color: var(--text);
    border-left: 4px solid var(--primary);
}

.alert-warning {
    background: linear-gradient(135deg, #fffaf0, #feebc8);
    color: #744210;
    border-left: 4px solid #d69e2e;
}

.alert-danger {
    background: linear-gradient(135deg, #fff5f5, #fed7d7);
    color: #742a2a;
    border-left: 4px solid var(--danger);
}

/* Tabla de citas existentes */
.table {
    color: var(--text);
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
}

.table thead th {
    background: var(--background-alt);
    color: var(--secondary);
    font-weight: 600;
    border-bottom: 2px solid var(--border);
    padding: 1rem 1.5rem;
    font-size: 0.95rem;
}

.table tbody td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: var(--primary-light);
}

.table tbody tr:last-child td {
    border-bottom: none;
}

/* Grid de horarios */
.row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.25rem;
    margin: 0;
}

/* Card footer */
.card-footer {
    background: var(--background-alt);
    border-top: 1px solid var(--border);
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Botón de buscar con animación */
#btnBuscarDisponibilidad .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Modo oscuro */
[data-tema="oscuro"] {
    --primary: #63b3ed;
    --primary-light: #2d3748;
    --secondary: #a0aec0;
    --accent: #68d391;
    --text: #e2e8f0;
    --text-light: #a0aec0;
    --background: #1a202c;
    --background-alt: #2d3748;
    --border: #4a5568;
    --shadow: rgba(0, 0, 0, 0.3);
    --danger: #fc8181;
    --danger-light: #742a2a;
}

[data-tema="oscuro"] #disponibilidad-citas {
    background: var(--background);
    border-color: var(--border);
}

[data-tema="oscuro"] .card {
    background: var(--background-alt);
    border-color: var(--border);
}

[data-tema="oscuro"] .horario-card {
    background: var(--background-alt);
    border-color: var(--border);
}

[data-tema="oscuro"] .horario-card.disponible:hover {
    background: #2d3748;
    border-color: var(--accent);
}

[data-tema="oscuro"] .horario-card.ocupado {
    border-color: var(--danger-light);
}

[data-tema="oscuro"] .horario-card.ocupado:hover {
    border-color: var(--danger);
}

[data-tema="oscuro"] .table thead th {
    background: #2d3748;
}

[data-tema="oscuro"] .table tbody tr:hover {
    background-color: #2d3748;
}

[data-tema="oscuro"] .alert-info {
    background: linear-gradient(135deg, #2d3748, #234e52);
    color: var(--text);
}

[data-tema="oscuro"] .alert-warning {
    background: linear-gradient(135deg, #44337a, #744210);
    color: #d6bcfa;
}

[data-tema="oscuro"] .alert-danger {
    background: linear-gradient(135deg, #742a2a, #521b41);
    color: #fed7d7;
}

/* Responsive */
@media (max-width: 768px) {
    .container.main-content {
        padding: 1rem;
    }
    
    #disponibilidad-citas {
        padding: 1.5rem;
    }
    
    #disponibilidad-citas h2 {
        font-size: 1.8rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .row {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .nav-tabs .nav-link {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        margin: 0 0.25rem;
    }
    
    .horario-card .card-body {
        padding: 1.25rem 0.75rem !important;
    }
    
    .horario-card .card-title {
        font-size: 1rem;
    }
    
    .table thead th,
    .table tbody td {
        padding: 0.75rem;
    }
    
    .btn-primary,
    .btn-success {
        padding: 0.75rem 1.5rem;
        width: 100%;
    }
}

@media (max-width: 480px) {
    #disponibilidad-citas {
        padding: 1rem;
    }
    
    #disponibilidad-citas h2 {
        font-size: 1.6rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .row {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    .nav-tabs {
        flex-direction: column;
    }
    
    .nav-tabs .nav-item {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .nav-tabs .nav-link {
        border-radius: 8px;
        margin: 0;
        text-align: center;
    }
    
    .nav-tabs .nav-link.active {
        border-bottom: 3px solid var(--primary);
        border-radius: 8px 8px 8px 8px;
    }
    
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formDisponibilidad = document.getElementById('formDisponibilidad');
    const resultadosDiv = document.getElementById('resultadosDisponibilidad');
    const btnBuscar = document.getElementById('btnBuscarDisponibilidad');
    
    // Establecer fecha mínima como hoy
    const fechaInput = document.getElementById('fecha_disponibilidad');
    const today = new Date().toISOString().split('T')[0];
    fechaInput.value = today;
    fechaInput.min = today;
    
    formDisponibilidad.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const medicoId = document.getElementById('medico_disponibilidad').value;
        const fecha = document.getElementById('fecha_disponibilidad').value;
        const turno = document.getElementById('turno_disponibilidad').value;
        
        if (!medicoId || !fecha) {
            mostrarAlerta('Por favor, seleccione un médico y una fecha.', 'warning');
            return;
        }
        
        // Cambiar texto del botón
        btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando...';
        btnBuscar.disabled = true;
        
        try {
            const response = await fetch('{% url "ver_disponibilidad" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    medico: medicoId,
                    fecha: fecha,
                    turno: turno
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarResultados(data);
                resultadosDiv.classList.remove('d-none');
                
                // Scroll suave a los resultados
                resultadosDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            } else {
                mostrarAlerta('Error: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarAlerta('Error al buscar disponibilidad. Intente nuevamente.', 'danger');
        } finally {
            btnBuscar.innerHTML = '<i class="fas fa-search me-2"></i>Buscar Disponibilidad';
            btnBuscar.disabled = false;
        }
    });
    
    function mostrarAlerta(mensaje, tipo) {
        // Remover alertas existentes
        const alertasExistentes = document.querySelectorAll('.alert-temporario');
        alertasExistentes.forEach(alerta => alerta.remove());
        
        // Crear alerta temporal
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-temporario alert-dismissible fade show`;
        alerta.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: var(--border-radius);
        `;
        alerta.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${tipo === 'warning' ? 'exclamation-triangle' : tipo === 'danger' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
                <div>${mensaje}</div>
            </div>
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(alerta);
        
        // Auto-remover después de 5 segundos
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 5000);
    }
    
    function mostrarResultados(data) {
        // Actualizar información del médico y fecha
        document.getElementById('medicoNombre').textContent = data.medico;
        document.getElementById('fechaSeleccionada').textContent = data.fecha;
        
        if (data.turno) {
            // Solo mostrar un turno específico
            const turnoTab = document.getElementById(`${data.turno}-tab`);
            if (turnoTab) {
                turnoTab.click(); // Activar el tab correspondiente
            }
            
            // Mostrar TODOS los horarios en el turno específico (disponibles y ocupados)
            mostrarTodosHorariosEnTurno(data.turno, data.horarios_disponibles, data.citas_existentes);
            
            // Mostrar citas existentes en la tabla
            mostrarCitasExistentes(data.citas_existentes);
            
            // Ocultar otros tabs
            ['mañana', 'tarde', 'noche'].forEach(t => {
                if (t !== data.turno) {
                    const tabBtn = document.getElementById(`${t}-tab`);
                    const tabPane = document.getElementById(t);
                    if (tabBtn) tabBtn.classList.add('d-none');
                    if (tabPane) tabPane.classList.add('d-none');
                }
            });
        } else {
            // Mostrar todos los turnos con TODOS los horarios
            mostrarTodosHorariosTodosTurnos(data.disponibilidad_turnos, data.citas_existentes);
        }
        
        // Configurar botón para agendar cita
        document.getElementById('btnAgendarDesdeDisponibilidad').onclick = function() {
            const medicoId = document.getElementById('medico_disponibilidad').value;
            const fecha = document.getElementById('fecha_disponibilidad').value;
            window.location.href = `{% url 'citas_agendar' %}?medico=${medicoId}&fecha=${fecha}`;
        };
    }
    
    function mostrarTodosHorariosEnTurno(turnoId, horariosDisponibles, citasExistentes) {
        const container = document.getElementById(`horarios${capitalizeFirstLetter(turnoId)}`);
        container.innerHTML = '';
        
        // Generar todos los horarios posibles para este turno
        const todosHorarios = generarHorariosParaTurno(turnoId);
        
        if (todosHorarios.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                        <div>
                            <h6 class="mb-1">No hay horarios configurados</h6>
                            <p class="mb-0">No hay horarios para este turno.</p>
                        </div>
                    </div>
                </div>
            `;
            return;
        }
        
        // Crear un mapa de horarios ocupados
        const horariosOcupados = new Map();
        citasExistentes.forEach(cita => {
            const horaInicio = cita.hora_inicio.substring(0, 5); // Formato "HH:MM"
            horariosOcupados.set(horaInicio, true);
        });
        
        // Crear un mapa de horarios disponibles del backend
        const horariosDisponiblesMap = new Map();
        horariosDisponibles.forEach(horario => {
            const horaInicio = horario.inicio.substring(0, 5); // Formato "HH:MM"
            horariosDisponiblesMap.set(horaInicio, horario);
        });
        
        // Mostrar todos los horarios
        todosHorarios.forEach(horario => {
            const horaFormatted = formatHora(horario);
            const estaOcupado = horariosOcupados.has(horario);
            const estaDisponible = horariosDisponiblesMap.has(horario) && !estaOcupado;
            
            const col = document.createElement('div');
            
            // Determinar clase y estado
            const estadoClase = estaOcupado ? 'ocupado' : 'disponible';
            const estadoBadge = estaOcupado ? 'danger' : 'success';
            const estadoTexto = estaOcupado ? 'Ocupado' : 'Disponible';
            
            col.innerHTML = `
                <div class="card horario-card ${estadoClase}" 
                     data-hora="${horario}" 
                     data-estado="${estadoClase}"
                     ${estaOcupado ? 'style="cursor: not-allowed;"' : 'onclick="seleccionarHorario(\'' + horario + '\', this)"'}>
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-clock me-2" style="color: ${estaOcupado ? 'var(--danger)' : 'var(--accent)'};"></i>
                            <h6 class="card-title mb-0">${horaFormatted}</h6>
                        </div>
                        <span class="badge bg-${estadoBadge}">${estadoTexto}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(col);
        });
    }
    
    function mostrarTodosHorariosTodosTurnos(disponibilidadTurnos, citasExistentes) {
        // Primero, ocultar la sección de citas existentes ya que los horarios ocupados se muestran en la cuadrícula
        document.getElementById('citasExistentesSection').classList.add('d-none');
        
        for (const [turno, info] of Object.entries(disponibilidadTurnos)) {
            const container = document.getElementById(`horarios${capitalizeFirstLetter(turno)}`);
            container.innerHTML = '';
            
            // Generar todos los horarios posibles para este turno
            const todosHorarios = generarHorariosParaTurno(turno);
            
            if (info.ocupado && todosHorarios.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger d-flex align-items-center">
                            <i class="fas fa-times-circle me-3 fs-4"></i>
                            <div>
                                <h6 class="mb-1">Turno completamente ocupado</h6>
                                <p class="mb-0">Todos los horarios en este turno están reservados.</p>
                            </div>
                        </div>
                    </div>
                `;
                continue;
            }
            
            // Filtrar citas de este turno específico
            const citasTurno = citasExistentes.filter(cita => {
                const hora = parseInt(cita.hora_inicio.split(':')[0]);
                return perteneceATurno(hora, turno);
            });
            
            // Crear un mapa de horarios ocupados para este turno
            const horariosOcupados = new Map();
            citasTurno.forEach(cita => {
                const horaInicio = cita.hora_inicio.substring(0, 5);
                horariosOcupados.set(horaInicio, true);
            });
            
            // Crear un mapa de horarios disponibles
            const horariosDisponiblesMap = new Map();
            if (info.horarios_disponibles) {
                info.horarios_disponibles.forEach(horario => {
                    const horaInicio = horario.inicio.substring(0, 5);
                    horariosDisponiblesMap.set(horaInicio, horario);
                });
            }
            
            // Mostrar todos los horarios
            todosHorarios.forEach(horario => {
                const horaFormatted = formatHora(horario);
                const estaOcupado = horariosOcupados.has(horario);
                const estaDisponible = horariosDisponiblesMap.has(horario) && !estaOcupado;
                
                const col = document.createElement('div');
                
                // Determinar clase y estado
                const estadoClase = estaOcupado ? 'ocupado' : 'disponible';
                const estadoBadge = estaOcupado ? 'danger' : 'success';
                const estadoTexto = estaOcupado ? 'Ocupado' : 'Disponible';
                
                col.innerHTML = `
                    <div class="card horario-card ${estadoClase}" 
                         data-hora="${horario}" 
                         data-estado="${estadoClase}"
                         ${estaOcupado ? 'style="cursor: not-allowed;"' : 'onclick="seleccionarHorario(\'' + horario + '\', this)"'}>
                        <div class="card-body text-center">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <i class="fas fa-clock me-2" style="color: ${estaOcupado ? 'var(--danger)' : 'var(--accent)'};"></i>
                                <h6 class="card-title mb-0">${horaFormatted}</h6>
                            </div>
                            <span class="badge bg-${estadoBadge}">${estadoTexto}</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
        }
    }
    
    function generarHorariosParaTurno(turno) {
        const horarios = [];
        let inicio, fin;
        
        switch(turno) {
            case 'mañana':
                inicio = 6;
                fin = 12;
                break;
            case 'tarde':
                inicio = 12;
                fin = 18;
                break;
            case 'noche':
                inicio = 18;
                fin = 24;
                break;
            default:
                return [];
        }
        
        for (let hora = inicio; hora < fin; hora++) {
            for (let minuto = 0; minuto < 60; minuto += 30) {
                const horaStr = hora.toString().padStart(2, '0');
                const minutoStr = minuto.toString().padStart(2, '0');
                horarios.push(`${horaStr}:${minutoStr}`);
            }
        }
        
        return horarios;
    }
    
    function formatHora(hora) {
        // Convertir de formato 24h a 12h
        const [hh, mm] = hora.split(':').map(Number);
        const ampm = hh >= 12 ? 'PM' : 'AM';
        const hora12 = hh % 12 || 12;
        return `${hora12}:${mm.toString().padStart(2, '0')} ${ampm}`;
    }
    
    function perteneceATurno(hora, turno) {
        switch(turno) {
            case 'mañana':
                return hora >= 6 && hora < 12;
            case 'tarde':
                return hora >= 12 && hora < 18;
            case 'noche':
                return hora >= 18 && hora < 24;
            default:
                return false;
        }
    }
    
    function mostrarCitasExistentes(citas) {
        const tbody = document.querySelector('#tablaCitasExistentes tbody');
        tbody.innerHTML = '';
        
        if (citas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center py-4" style="color: var(--text-light);">
                        <i class="fas fa-calendar-check me-2"></i>No hay citas agendadas para esta fecha
                    </td>
                </tr>
            `;
            document.getElementById('citasExistentesSection').classList.add('d-none');
            return;
        }
        
        document.getElementById('citasExistentesSection').classList.remove('d-none');
        
        citas.forEach(cita => {
            const row = document.createElement('tr');
            
            let estadoBadge = '';
            switch(cita.estado) {
                case 'agendada':
                    estadoBadge = '<span class="badge bg-primary"><i class="fas fa-calendar me-1"></i>Agendada</span>';
                    break;
                case 'confirmada':
                    estadoBadge = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Confirmada</span>';
                    break;
                case 'en_progreso':
                    estadoBadge = '<span class="badge bg-warning"><i class="fas fa-spinner me-1"></i>En Progreso</span>';
                    break;
                default:
                    estadoBadge = `<span class="badge bg-secondary"><i class="fas fa-question-circle me-1"></i>${cita.estado}</span>`;
            }
            
            row.innerHTML = `
                <td>
                    <i class="fas fa-clock me-2" style="color: var(--accent);"></i>
                    ${cita.hora_inicio} - ${cita.hora_fin}
                </td>
                <td>${cita.paciente}</td>
                <td>${estadoBadge}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// Función global para seleccionar horarios
function seleccionarHorario(hora, elemento) {
    // Solo permitir selección si no está ocupado
    if (elemento.classList.contains('ocupado')) {
        mostrarAlerta('Este horario está ocupado. Por favor, seleccione otro horario disponible.', 'warning');
        return;
    }
    
    // Remover selección previa
    document.querySelectorAll('.horario-card.disponible').forEach(card => {
        card.style.borderColor = '';
        card.style.boxShadow = '';
        card.style.transform = '';
    });
    
    // Marcar como seleccionado
    elemento.style.borderColor = 'var(--accent)';
    elemento.style.boxShadow = '0 12px 25px rgba(0, 0, 0, 0.2)';
    elemento.style.transform = 'translateY(-6px)';
    
    // Agregar animación de pulso
    elemento.style.animation = 'pulse 0.5s';
    setTimeout(() => {
        elemento.style.animation = '';
    }, 500);
    
    // Guardar la hora seleccionada para el agendamiento
    sessionStorage.setItem('horaSeleccionada', hora);
    
    // Mostrar mensaje de confirmación
    const horaFormateada = elemento.querySelector('.card-title').textContent;
    mostrarAlerta(`Horario seleccionado: ${horaFormateada}. Haga clic en "Agendar Cita" para continuar.`, 'success');
}

// Función global para mostrar alertas
function mostrarAlerta(mensaje, tipo) {
    // Remover alertas existentes
    const alertasExistentes = document.querySelectorAll('.alert-temporario');
    alertasExistentes.forEach(alerta => alerta.remove());
    
    // Crear alerta temporal
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-temporario alert-dismissible fade show`;
    alerta.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: var(--border-radius);
    `;
    alerta.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${tipo === 'warning' ? 'exclamation-triangle' : tipo === 'danger' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
            <div>${mensaje}</div>
        </div>
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alerta);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (alerta.parentNode) {
            alerta.remove();
        }
    }, 5000);
}

// Añadir animación de pulso al CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { transform: translateY(-6px) scale(1); }
        50% { transform: translateY(-6px) scale(1.05); }
        100% { transform: translateY(-6px) scale(1); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}